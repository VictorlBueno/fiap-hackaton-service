import { Injectable, OnModuleInit } from '@nestjs/common';
import { RabbitMQService, VideoProcessingMessage } from './rabbitmq.service';
import * as fs from 'fs/promises';
import {ProcessVideoUseCase} from "../../application/usecases/process-video.usecase";

@Injectable()
export class VideoQueueProcessorService implements OnModuleInit {
    constructor(
        private readonly rabbitMQService: RabbitMQService,
        private readonly processVideoUseCase: ProcessVideoUseCase,
    ) {}

    async onModuleInit() {
        console.log('ğŸ¯ Iniciando VideoQueueProcessorService...');

        // Aguarda um pouco para garantir que RabbitMQ estÃ¡ conectado
        setTimeout(async () => {
            await this.startConsumer();
        }, 2000);
    }

    private async startConsumer() {
        try {
            console.log('ğŸ¯ Iniciando consumidor da fila...');
            await this.rabbitMQService.consumeQueue(this.processVideoMessage.bind(this));
            console.log('âœ… Consumidor da fila iniciado com sucesso');
        } catch (error) {
            console.error('âŒ Erro ao iniciar consumidor:', error.message);

            // Tenta reconectar apÃ³s 5 segundos
            setTimeout(() => {
                console.log('ğŸ”„ Tentando reconectar consumidor...');
                this.startConsumer();
            }, 5000);
        }
    }

    private async processVideoMessage(message: VideoProcessingMessage): Promise<void> {
        console.log(`ğŸ¬ Iniciando processamento em background: ${message.originalName} (ID: ${message.id})`);

        try {
            const result = await this.processVideoUseCase.execute(message.videoPath, message.timestamp);

            if (result.success) {
                console.log(`âœ… Processamento concluÃ­do: ${message.id} - ${result.frameCount} frames`);

                // Remove arquivo original apÃ³s processamento bem-sucedido
                try {
                    await fs.unlink(message.videoPath);
                    console.log(`ğŸ—‘ï¸ Arquivo original removido: ${message.videoPath}`);
                } catch (error) {
                    console.warn(`âš ï¸ Erro ao remover arquivo: ${error.message}`);
                }
            } else {
                console.error(`âŒ Falha no processamento: ${message.id} - ${result.message}`);
            }

            console.log(`âœ… Processamento background concluÃ­do: ${message.id}`);
        } catch (error) {
            console.error(`âŒ Erro no processamento background: ${message.id}`, error.message);
            throw error; // Re-throw para que o RabbitMQ saiba que falhou
        }
    }
}